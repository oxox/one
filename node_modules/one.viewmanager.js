/**
 * view manager module
 * @module core
 * @class ViewManager
 */
module.exports=(function(x){
	var util = require('one.util'),
		ini = require('one.ini'),
		async = require('async'),
		jade = require('jade'),
		path = require('path');

	x.viewPath = util.appRoot+'assets\\views\\'+ini.language+'\\';
	x.defaultPath = util.appRoot+'assets\\views\\'+ini.defaultLanguage+'\\';
	x.view={};
	x.files={};

	x.ready = function(cbk){
		util.fs.readdir(x.viewPath,function(err,files){
			if (err) {
				return cbk(err);
			};
			var len = files.length;
			if (len===0) {
				return cbk('模板404！');
			};
			var fileNameList = [];
			for (var i = len - 1; i >= 0; i--) {
				files[i]=x.viewPath+files[i];
				fileNameList[i] = path.basename(files[i],'.jade');
			};
			//read all template files
			async.map(files,util.fs.readFile,function(err1,files1){
				if (err1) {
					return cbk(err1);
				};
				for (var i = len - 1; i >= 0; i--) {
					files1[i]={
						"name":fileNameList[i],
						"data":files1[i].toString()
					};
				};
				x.files = files1;
				//compile all files
				async.each(files1,function(file2,cbk2){
					try{
						x.view[file2.name]=jade.compile(file2.data);
						cbk2(null,file2);
					}catch(e){
						cbk2(e);
					}
				},function(err3){
					if (err3) {
						return cbk(err3);
					};
					cbk.call(x,null)
				});
			});
		});
	};

	//test
    /*
	x.ready(function(err){
		if (err) {
			alert(err.toString());
			return;
		};
		console.log(this);
	});
    */

	return x;
})({});